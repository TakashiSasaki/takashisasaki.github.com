<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OAuth2における認可の実験</title>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.css"/>
    <link rel="stylesheet" href="icon.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
<div data-role="page">
    <header data-role="header">
        <h3>
            Confidential Client with Authorization Code Grant
        </h3>
        <a href="#panel" class="ui-btn ui-icon-bars ui-btn-icon-left"></a>
    </header>
    <div class="ui-content" role="main">
        <p>OAuth2ではPublicクライアントとConfidentialクライアントが定義されている。
            Publicクライアントはブラウザを含めユーザーのデバイスの上で動くような
            client_secretを秘密にできないクライアント、
            Confidentialクライアントはサーバ上で動くようなclient_secretを秘密にできるクライアントである。
        </p>

        <p>Authorization Code Grantでは、クライアントは最初に認可コードを取得し、
            それをアクセストークンと引き換える。この際にリフレッシュトークンが得られる場合もある。
            リフレッシュトークンを使って、期限の切れたアクセストークンを更新することができる。
        </p>

        <div class="ui-corner-all">
            <div class="ui-bar ui-bar-a"><h3>①OOBによる認可コードの取得</h3></div>
            <div class="ui-body ui-body-a">
                <p>リダイレクト先としてOOB(out-of-band)を、
                    レスポンスタイプとしてcodeを指定し認可のためのサーバを呼び出す。
                    OOBとはユーザーが認可コードをコピーアンドペーストなどの方法で取り扱う必要があることを意味する。
                    認可サーバ上のページに認可コードが表示される。</p>
                <a id="authorization_url_oob" class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline"
                   target="_blank">
                    リダイレクト先をOOBとして認可コードを取得する</a>

                <p>リダイレクト先としてhttp://localhostを、レスポンスタイプとしてcodeを指定し認可のためのサーバを呼び出す。
                    localhostのウェブサーバが適切に設定されていればそこで認可コードを受け取ることができる。
                    そうでない場合は単に空白かlocalhostに接続できない旨を表示するブラウザからのエラーを
                    示すページが表示されるだろう。
                </p>
                <a id="authorization_url_localhost" class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline"
                   target="_blank">
                    リダイレクト先をlocalhostとして認可コードを取得する</a>
            </div>
            <div class="ui-bar ui-bar-a">
                <h3>②認可コードをアクセストークンへ交換</h3></div>
            <div class="ui-body ui-body-a">
                <p>残念ながらXmlHttpRequestを使って認可コードをアクセストークンに交換しようとしても、
                    サーバ側がAccess-Control-Allow-Origin:*を付けるなどの方法でクロスドメイン制約を
                    外してくれていないとたいていのブラウザでは動かない。</p>
                <input name="code" placeholder="ここに①で取得した認可コードを貼り付けて下さい" id="authorization_code">
                <button id="access_token_link" class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline">
                    アクセストークンの取得
                </button>
                <input id="access_token_result" placeholder="結果がここに表示されます" readonly="true">
            </div>
        </div>
        <div class="ui-corner-all">
            <div class="ui-bar ui-bar-a">
                <h3>アクセストークンを取得</h3>
            </div>
            <div class="ui-body ui-body-a">
                <a id="authorization_url_web"
                   class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline">アクセストークンを取得</a>
                <input readonly="true" id="authorization_url_web_input">
            </div>
        </div>
    </div>
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script>
<script src="http://url.websanova.com/url.min.js"></script>
<script src="panel.js"></script>
<script>
    var base_url = window.url("protocol") + "://" + window.url("hostname") + ":" +
            window.url("port") + window.url("path");

    if (window.url("#access_token") != null) {
        alert("access_token = " + window.url("#access_token"));
    }

    var token_endpoint = "https://accounts.google.com/o/oauth2/token";
    var auth_endpoint = "https://accounts.google.com/o/oauth2/auth";
    var client_id = "982049359064-m16bre9h586ao9q3hh08hau26v4m7c9i.apps.googleusercontent.com";
    var client_secret = "4fNom33Z_nWujtQaFJzYIxjV";
    var authorization_url_oob = auth_endpoint + "?"
            + "scope=email%20profile&"
            + "state=%2Fprofile&"
            + "redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&"
            + "response_type=code&"
            + "client_id=" + client_id;

    var authorization_base_url = "https://accounts.google.com/o/oauth2/auth"
    var authorization_url_localhost = authorization_base_url + "?"
            + "scope=email%20profile&"
            + "state=%2Fprofile&"
            + "redirect_uri=http://localhost&"
            + "response_type=code&"
            + "client_id=" + client_id;

    var web_client_id = "982049359064-khobeosb81scm9kt1387mg78o399t71u.apps.googleusercontent.com";
    var authorization_url_web = authorization_base_url + "?"
            + "scope=email%20profile&"
            + "redirect_uri=" + encodeURIComponent(base_url) + "&"
            + "response_type=token&"
            + "client_id=" + web_client_id;


    $(document).on("pagecreate", function (e, ui) {
        $("#authorization_url_oob").attr("href", authorization_url_oob);
        $("#authorization_url_localhost").attr("href", authorization_url_localhost);
        $("#authorization_url_web").attr("href", authorization_url_web);
        $("#authorization_url_web_input").val(authorization_url_web);
    });


    $("#access_token_link").on("click", function () {
                try {
                    $.ajax(
                            {
                                type: "post",
                                url: token_endpoint,
                                data: {
                                    client_id: client_id,
                                    client_secret: client_secret,
                                    grant_type: "authorization_code",
                                    code: $("#authorization_code").val(),
                                    redirect_uri: "http://localhost"
                                }
                            }
                    ).done(function (e) {
                                $("#access_token_result").val("done");
                            }).fail(function (jqxhr, textstatus, e) {
                                $("#access_token_result").val(textstatus);
                            }).always(function (e) {
                            });
                }
                catch (e) {
                    $("#access_token_result").val(e);
                }
            }
    );
</script>
</body>
</html>
