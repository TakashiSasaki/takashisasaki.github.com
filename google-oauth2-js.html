<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OAuth2における認可の実験</title>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.css"/>
    <link rel="stylesheet" href="icon.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
<div data-role='panel' id='panel' data-display="overlay" data-theme="b"></div>
<div data-role="page" id="installed-apps">
    <header data-role="header">
        <h3>OAuth2 for Installed Apps</h3>
        <a href="#panel" class="ui-btn ui-icon-bars ui-btn-icon-left"></a>
    </header>
    <div class="ui-content" role="main">
        <p>Google APIを使うためのOAuth2による認可において、
            ブラウザなどのリッチクライアントが搭載されたデバイスでは<span class="auth_endpoint var">
            </span>をエンドポイントとしてAuthorization Code Grantを行う。
        </p>

        <p>Authorization Code Grantでは、クライアントは最初に認可コードを取得し、
            それをアクセストークンと引き換える。この際にリフレッシュトークンが得られる場合もある。
            リフレッシュトークンを使って、期限の切れたアクセストークンを更新することができる。
            このときclient_secretが必要となるので、Confidentialクライアントとして扱われていることになる。
        </p>

        <p>OAuth2ではPublicクライアントとConfidentialクライアントが定義されている。
            Publicクライアントはブラウザを含めユーザーのデバイスの上で動くような
            client_secretを秘密にできないクライアント、
            Confidentialクライアントはサーバ上で動くようなclient_secretを秘密にできるクライアントである。
        </p>


        <div class="ui-corner-all">
            <div class="ui-bar ui-bar-a"><h3>①OOBによる認可コードの取得</h3></div>
            <div class="ui-body ui-body-a">
                <p>リダイレクト先としてOOB(out-of-band)を、
                    レスポンスタイプとしてcodeを指定し認可のためのサーバを呼び出す。
                    OOBとはユーザーが認可コードをコピーアンドペーストなどの方法で取り扱う必要があることを意味する。
                    認可サーバ上のページに認可コードが表示される。</p>
                <a class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline oob"
                   target="_blank">
                    リダイレクト先をOOBとして認可コードを取得する</a>

                <p>リダイレクト先としてhttp://localhostを、レスポンスタイプとしてcodeを指定し認可のためのサーバを呼び出す。
                    localhostのウェブサーバが適切に設定されていればそこで認可コードを受け取ることができる。
                    そうでない場合は単に空白かlocalhostに接続できない旨を表示するブラウザからのエラーを
                    示すページが表示されるだろう。
                </p>
                <a class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline localhost"
                   target="_blank">
                    リダイレクト先をlocalhostとして認可コードを取得する</a>
            </div>
            <div class="ui-bar ui-bar-a">
                <h3>②認可コードをアクセストークンへ交換</h3></div>
            <div class="ui-body ui-body-a">
                <p>残念ながらXmlHttpRequestを使って認可コードをアクセストークンに交換しようとしても、
                    サーバ側がAccess-Control-Allow-Origin:*を付けるなどの方法でクロスドメイン制約を
                    外してくれていないとたいていのブラウザでは動かない。
                    下のボタンをクリックするとXmlHttpRequestが実行されるが、
                    サーバーからのレスポンスを拒否するので何も起こらない。</p>
                <input name="code" placeholder="ここに①で取得した認可コードを貼り付けて下さい" id="authorization_code">
                <textarea placeholder="POSTすべきデータがここに表示されます" readonly="true" class="ajax_data"></textarea>
                <button class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline ajax_data">
                    XmlHttpRequestで認可コードをアクセストークンへ交換（失敗します）
                </button>
                <form method="post" action="http://localhost/proxy">
                    <textarea placeholder="AJAXプロキシにPOSTするデータがここに表示されます" readonly="true"
                              class="ajax_options" rows="5" name="ajax_options"></textarea>
                    <button class="ajax_options" type="submit">AJAXプロキシ経由で認可コードをアクセストークンへ交換</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div data-role="page" id="client-side">
    <header data-role="header">
        <h3> OAuth2 for Client-side</h3>
        <a href="#panel" class="ui-btn ui-icon-bars ui-btn-icon-left"></a>
    </header>
    <p>Google APIを使うためのOAuth2による認可において、
        ブラウザ上で動くJavaScriptアプリのためには<span class="auth_endpoint var"></span>をエンドポイントとしたImplicit Grantを行う。
        認可コードを得る手順を省略してアクセストークンが得られる。
        client_secretは要求されないためPublicクライアント扱いである。
        リフレッシュトークンは得られないので、頻繁に認可が必要となる。
    </p>

    <div class="ui-corner-all">
        <div class="ui-bar ui-bar-a">
            <h3>アクセストークンを取得</h3>
        </div>
        <div class="ui-body ui-body-a">
            <a class="ui-btn ui-btn-icon-left ui-icon-oauth ui-btn-inline">アクセストークンを取得</a>
            <input readonly="true" class="url">
            <input readonly="true" class="token">
        </div>
    </div>
</div>
<div data-role="page" id="devices">
    <header data-role="header">
        <h3>
            Confidential Client with Authorization Code Grant
        </h3>
        <a href="#panel" class="ui-btn ui-icon-bars ui-btn-icon-left"></a>
    </header>
    <p>テンキーなどの簡単な入力装置しか持たないセットトップボックスなどが
        Google APIを使うためにOAuth2での認可を受けるには、
        ブラウザ上で動くJavaScriptアプリのためには<span class="auth_endpoint var"></span>をエンドポイントとしたImplicit Grantを行う。
        認可コードを得る手順を省略してアクセストークンが得られる。
        client_secretは要求されないためPublicクライアント扱いである。
        リフレッシュトークンは得られないので、頻繁に認可が必要となる。
    </p>

    <p>下のボタンを押すとXmlHttpRequestでデバイスコードとユーザーコードを取得しようとするが、
        サーバーからのレスポンスヘッダにAccess-Control-Allow-Originが設定されていないため失敗する。</p>
    <button>デバイスコードとユーザーコードを取得する</button>
    <input class="device_code">
    <input class="user_code">
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script>
<script src="http://url.websanova.com/url.min.js"></script>
<script src="http://timeago.yarp.com/jquery.timeago.js"></script>
<script src="panel.js"></script>
<script>
    var base_url = window.url("protocol") + "://" + window.url("hostname") + ":" +
            window.url("port") + window.url("path");

    if (window.url("#access_token") != null) {
        if (window.url("#state") == "client-side") {
            $("#client-side input.token").val(window.url("#access_token"));
            setTimeout(function () {
                $(':mobile-pagecontainer').pagecontainer("change", "#client-side", {transition: 'flip', changeHash: false});
            }, 2000);
        }
    }

    var token_endpoint = "https://accounts.google.com/o/oauth2/token";
    var auth_endpoint = "https://accounts.google.com/o/oauth2/auth";
    var device_endpoint = "https://accounts.google.com/o/oauth2/device/code";

    $(".auth_endpoint").text(auth_endpoint);


    var native_app_client_id = "982049359064-m16bre9h586ao9q3hh08hau26v4m7c9i.apps.googleusercontent.com";
    var native_app_client_secret = "4fNom33Z_nWujtQaFJzYIxjV";
    var web_app_client_id = "982049359064-khobeosb81scm9kt1387mg78o399t71u.apps.googleusercontent.com";

    var authorization_url_oob = auth_endpoint + "?"
            + "scope=email%20profile&"
            + "state=%2Fprofile&"
            + "redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&"
            + "response_type=code&"
            + "client_id=" + native_app_client_id;

    var authorization_url_localhost = auth_endpoint + "?"
            + "scope=email%20profile&"
            + "state=%2Fprofile&"
            + "redirect_uri=http://localhost&"
            + "response_type=code&"
            + "client_id=" + native_app_client_id;

    var authorization_url_web = auth_endpoint + "?"
            + "scope=email%20profile&"
            + "redirect_uri=" + encodeURIComponent(base_url) + "&"
            + "response_type=token&"
            + "client_id=" + web_app_client_id + "&"
            + "state=client-side";


    $(document).on("pagecreate", function (e, ui) {
        $("#installed-apps A.oob").attr("href", authorization_url_oob);
        $("#installed-apps A.localhost").attr("href", authorization_url_localhost);
        $("#client-side div a").attr("href", authorization_url_web);
        $("#client-side input.url").val(authorization_url_web);
    });

    $("#authorization_code").on("keyup",
            function () {
                var data = {
                    client_id: native_app_client_id,
                    client_secret: native_app_client_secret,
                    grant_type: "authorization_code",
                    code: $("#authorization_code").val(),
                    redirect_uri: "urn:ietf:wg:oauth:2.0:oob"
                }
                $("#installed-apps TEXTAREA.ajax_data").val(window.JSON.stringify(data));
                $("#installed-apps TEXTAREA.ajax_data").keyup();
                var ajax_option = {type: "post", url: token_endpoint, data: data};
                $("#installed-apps TEXTAREA.ajax_options").val(window.JSON.stringify(ajax_option));
                $("#installed-apps TEXTAREA.ajax_options").keyup();
            }
    );


    $("#installed-apps BUTTON.ajax_data").on("click", function () {
                var data = window.JSON.parse(
                        $("#installed-apps TEXTAREA.ajax_data").val());
                try {
                    $.ajax(window.JSON.parse($("#installed-apps TEXTAREA.ajax_options").val())).
                            done(function (e) {
                                $("#access_token_result").val("done");
                            }).fail(function (jqxhr, textstatus, e) {
                                $("#access_token_result").val(textstatus);
                            }).always(function (e) {
                            });
                } catch (e) {
                    $("#access_token_result").val(e);
                }
            }
    );

    $("#devices button").on("click", function () {
        var data = {
            client_id: native_app_client_id,
            scope: "email profile"
        }
        $.ajax({type: "post", url: device_endpoint, data: data, dataType: "json"}).done(function (j) {
            $("#devices input.device_code").val(j.device_code);
            $("#devices input.user_code").val(j.user_code);
        });
    });
</script>
</body>
</html>
